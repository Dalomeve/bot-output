---
name: zh-encoding-fix
description: Detect and repair mojibake in markdown/json/text files, then enforce UTF-8 safe write rules to prevent recurrence.
---

# ZH Encoding Fix

Repair garbled text deterministically and prevent future corruption.

## Trigger

Use this skill when:
- Chinese text becomes unreadable after write or edit operations
- Files show mojibake markers (for example `\\uFFFD`, `A-tilde` artifacts, or broken punctuation sequences)
- A generated skill or doc is clearly corrupted

## Scope

- Target files: `SKILL.md`, `.md`, `.txt`, `.json` (text only)
- Do not touch binaries

## Workflow

### 1) Detect

Run a quick scan for suspicious patterns:

```powershell
Get-ChildItem -Recurse -File -Include *.md,*.txt,*.json |
  Select-String -Pattern '�|锛|锟|鈥|馃|Ã[A-Za-z0-9]|Â[ -~]|â€[ -~]|ðŸ'
```

If no hits, stop and return `ENCODING_OK`.

### 2) Backup

Create `.bak.<timestamp>` before any rewrite.

### 3) Attempt deterministic recovery

Use `scripts/repair-mojibake.ps1`:
- For each line, try CP936 bytes -> UTF-8 decode recovery
- Keep candidate line only if readability score improves and mojibake markers decrease
- Preserve original line if confidence is low

### 4) Validate

Pass only if all are true:
- mojibake markers reduced to zero (or documented residual)
- file remains valid UTF-8
- no accidental truncation

### 5) Fallback

If confidence is low or output still corrupted:
- rewrite affected section in plain ASCII English
- keep original in backup for manual recovery

## Done Criteria

```markdown
DONE_CHECKLIST
- Files scanned: <n>
- Corrupted files detected: <n>
- Files repaired: <n>
- Backup created: yes/no
- Residual mojibake markers: <n>
- Evidence: <file paths + before/after summary>
```

## Safety

- Never overwrite without backup
- Never claim success without post-scan
- Never decode binary files
- Prefer readable ASCII fallback over uncertain CJK recovery

## Prevention Rules

- Keep generated `SKILL.md` content ASCII-first unless user explicitly requires Chinese
- In PowerShell, force UTF-8 before running agent generation
- After generation, run one mojibake scan before publish
